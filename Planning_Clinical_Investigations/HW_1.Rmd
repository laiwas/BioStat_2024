---
title: "Sample_Size_HW"
author: "Kravets A.A."
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(TrialSize)
library(epiR)
library(DescTools)
library(rpact)

set.seed(42)

```

# Задача №1
## Дизайн
Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении
хронической обструктивной болезни лёгких (ХОБЛ). Первичная конечная точка – абсолютное
увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на
1 визите.
Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3
месяца в среднем (M±SD) составлял 7.2 ± 3.1%. Предлагаемая граница не меньшей
эффективности – 2 %.

## Решение
Статистическая гипотеза не меньшей эффективности в исследовании была сформулирована следующим
образом:
H0: M_T – M_R ≤ δ
HA: M_T – M_R > δ
Где 
M_T – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на
1 визите в исследуемой группе;
M_R – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на
1 визите в контрольной группе
δ – граница не меньшей эффективности (-2%).

При расчёте необходимого размера выборки были сделаны следующие допущения:
1. Распределение в группы будет равномерным в соотношении 1:1;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина
ошибки II рода (β) = 0.2;
4. Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3
месяца в среднем (M±SD) составлял 7.2 ± 3.1%. Для исследуемого препарата значения среднего и стандартного отклонения были взятые такие же.
5. Граница не меньшей эффективности препарата по сравнению с  контролем равна -2%.
Расчёт размера выборки был проведён в RStudio (Release (e4392fc9, 2024-06-05)) c использованием
языка R (версия 4.4.1) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия 1.4.1).

```{r}
result_size = TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma=3.1,
    k = 1,
    delta = -2,
    margin = 0
)

result_size = ceiling(result_size) # округляем в высшую сторону

result_size
```
38 пациентов в каждую группу, с учётов 20% потери в ходе исследования и 10% потери пациентов на стадии скрининга получаем:
```{r}
result_size = ceiling(result_size*1.2*1.1)
result_size
```
Итого: 51 пациент в каждую группу. Суммарно: 102 пациента.

Проверка на Epir - первую чиселку получили точно такую же.
```{r}

epi.ssninfc(
    treat = 7.2,
    control = 7.2,
    sigma = 3.1,
    delta = 2,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 1,
    nfractional = T
)

```

# Задача №2
## Дизайн
Исследование превосходства препарата T над референтным лечением R в лечении
рассеянного склероза. Первичный показатель эффективности – доля пациентов, у которых к
визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно
литературным данным, на фоне применения препарата R доля пациентов без новых очагов
составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на
15%, при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1%. Спонсор
просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.

## Решение
Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:
H0: P_T – P_R <= δ
HA: P_T – P_R > δ
Где 
P_T – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения в группе исследуемого препрата; 
P_R – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения;
δ – граница превосходства (1%).

При расчёте необходимого размера выборки были сделаны следующие допущения:
1. Распределение в группы будет в соотношении 2:1;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина
ошибки II рода (β) = 0.2;
4. Из литературных данных известно, что для препарата R искомая доля равна 66%. Для исследуемого препарата ожидаемое повышение эффективности составляет 15%, т.о. искомая доля равна 81%.
5. Граница превосходства о сравнению с  контролем равна 1%.

Расчёт размера выборки был проведён в RStudio (Release (e4392fc9, 2024-06-05)) c использованием
языка R (версия 4.4.1) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия 1.4.1).

```{r}
result_size = TwoSampleProportion.NIS(
    alpha = 0.025,
    beta = 0.2,
    p1= 0.81,
    p2= 0.66,
    k = 2,
    delta = 0.15,
    margin = 0.01
)

result_size = ceiling(result_size) # округляем в высшую сторону

result_size
```
242 пациента в группу с исследуемым препаратом и 121 пациент в группу с контролем, с учётов 20% потери в ходе исследования и 10% потери пациентов на стадии скрининга получаем:
```{r}
result_size = ceiling(result_size*1.2*1.1)
result_size
```
Итого: суммарно 480 пациентов (320 - исследуемая, 160 - контроль).

Проверка на Epir - первые чиселки получили точно такие же.
```{r}

epi.sssupb(
    treat = 0.81,
    control = 0.66,
    delta = 0.01,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 2
)

```

# Задача №3
## Дизайн
Исследование превосходства нового препарата А над препаратом Б в профилактике
интраоперационных кровотечений. Первичная конечная точка – объём кровопотери в мл. Из
данных литературы известно, что средний объём кровопотери при применении препарата Б
составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём
кровопотери на 20% в сравнении с препаратом Б. Границу превосходства предполагается
установить равной 50 мл. Спонсор просит рассчитать объём выборок таким образом, чтобы
препарат А получили 75% пациентов, включённых в исследование.

## Решение
Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:
H0: M_T – M_R >= δ
HA: M_T – M_R < δ
Где 
M_T – объём кровопотери в мл. в группе исследуемого препарата А; 
M_R – объём кровопотери в мл. в группе контрольного препарата Б;
δ – граница превосходства (-50 мл.). 

При расчёте необходимого размера выборки были сделаны следующие допущения:
1. Распределение в группы будет в соотношении 3:4;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина
ошибки II рода (β) = 0.2;
4. Из литературных данных известно, что для препарата Б средний объём кровопотери 306 ± 52 мл. Для исследуемого препарата А средний объём кровопотери 241.6 мл (стандартное отклонение не известно, поэтому считается равным отклонению препарата Б).
5. Граница превосходства о сравнению с контролем равна -50 мл.

Расчёт размера выборки был проведён в RStudio (Release (e4392fc9, 2024-06-05)) c использованием
языка R (версия 4.4.1) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия 1.4.1).

```{r}
result_size = TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 52,
    k = 0.75,
    delta = -50,
    margin = 241.6 - 306
)

result_size = ceiling(result_size) # округляем в высшую сторону

result_size
```
180 пациента в группу с исследуемым препаратом и 240 пациент в группу с контролем, с учётов 20% потери в ходе исследования и 10% потери пациентов на стадии скрининга получаем:
```{r}
summary_size = ceiling((240)*1.2*1.1)
summary_size
```
Итого: суммарно 238+317=555 пациентов (238 - исследуемая, 317 - контроль).

Проверка на Epir - первую чиселку получили точно такую же.
```{r}

epi.sssupc(
    treat = 306,
    control = 241.6,
    sigma = 52,
    delta = 50,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 0.75,
    nfractional = T
)

```

# Задача №4
## Дизайн
Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев
наблюдается в 32% случаев. Спонсор хочет исследовать новый препарат У, который, как
ожидается, снизит частоту рецидивов на 15%. Границей превосходства можно считать
снижение доли пациентов с рецидивом более, чем на 5%.
При этом существует сложность. У спонсора в наличии имеется только 250 пачек препарата Х и
он просит, чтобы рандомизационное соотношение было таким, чтобы препарата хватило на
проведение исследования.

## Решение
Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:
H0: P_T – P_R >= δ
HA: P_T – P_R < δ
Где 
P_T – доля рецидивов псориатического артрита (за 6 месяцев) в группе исследуемого препрата Y; 
P_R – доля рецидивов псориатического артрита (за 6 месяцев) в группе котрольного препарата X;
δ – граница превосходства (-5%).

При расчёте необходимого размера выборки были сделаны следующие допущения:
1. Исследование ограничено тем, что у спонсора в наличии 250 пачек препарата X [контрольного препарата]. Кол-во пачек исследуемого препарата неограниченно.
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина
ошибки II рода (β) = 0.2;
4. Из литературных данных известно, что для препарата X доля рецидивов - 32%. Для исследуемого препарата Y  доля рецидивов предполагается равной 17%.
5. Граница превосходства о сравнению с  контролем равна -5%.

Расчёт размера выборки был проведён в RStudio (Release (e4392fc9, 2024-06-05)) c использованием
языка R (версия 4.4.1) с помощью функции epi.sssupb пакета EpiR (версия 2.0.77).

Рассчёты на EpiR - NB! в функции treat = контрольный препарат Х, control = препарат Y. Из-за этого сменился знак дельты на положительный.
```{r}

for (r in seq(0.05, 2, by=0.05)) {
  project = epi.sssupb(
    treat = 0.32,
    control = 0.17,
    delta = 0.05,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = r
)
  result = if_else(project$n.treat*1.2 < 250, 1*project$n.treat, -1*project$n.treat)*project$n.control
  print(paste("Ratio:", r, " Sizes Loss:", result))
}

```
В этом простом коде мы смотрели на разные соотношения между контрольной и исследуемой группами. Опять же, важно помнить, что у нас в функции n.treat = размер контрольной группы. n.control = размер исследуемой группы. Получается, чтобы ограничить пациентов истинной контрольной группы, нам нужно понижать n.treat. Собственно, r у нас должно быть меньше < 1.

В аутпуте кода выше можно видеть, как при разных r (от 0.25 до 2.5 с шагом 0.1) ведет себя кастомная лосс-функция, которая состоит в том, что мы перемножаем размеры выборок между собой со знаком - или +, в зависимости от размера $n.treat (больше или меньше 250, соответственно). Важно! в лосс функции учитываем 20% пациентов, которые выбудут из исследования, 10% потери на скрининге не учитываем (они же не будут получать препарат)!

Т.о. выбираем соотношение 0.3 [можно было и поточнее, но 0.3 и выглядит адекватно (для регуляторов, имхо) и функцию свою выполняет].

```{r}

results = epi.sssupb(
    treat = 0.32,
    control = 0.17,
    delta = 0.05,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 0.3
)

results

```

Получаем: в группе с Х - 244 пациента
```{r}
result_size_control = ceiling(results$n.treat*1.2*1.1)
result_size_control
```
```{r}
result_size_treat = ceiling(results$n.control*1.2*1.1)
result_size_treat
```

Итого: суммарно 271+899=1170 пациентов (899 - исследуемая, 271 - контроль). Здесь все вычисления с учетом потерь на скрининге и потенциально выбывших из исследования пациентов.