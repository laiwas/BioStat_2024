---
title: "Классические_статистические_тесты - Home Work"
author: "Andrey Kravets"
date: "2024-11-25"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез.
В качестве задания протестируйте их, используя соответствующие статистические критерии.
Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы.
При необходимости аргументируйте выбор одностороннего теста.
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.

-   Решение необходимо загружать в формате Rmd (воспроизводимый код). \*\* Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr \*\*\* Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).

# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size \<- 100). Как изменится стратегия при малых выборках (sample_size \<- 30) ?

## Генерация данных и Решение

-   Гипотезы:
    -   Нулевая гипотеза: уровень физической активности и частота сердечно-сосудистных заболеваний независимы
    -   Альтернативная гипотеза: уровень физической активности и частота сердечно-сосудистных заболеваний зависимы
-   Уровень значимости: классический, alpha = 0.05
-   Стат.тест:
    -   Для маленькой выборки Стат.тест Фишера - т.к. на таких выборках он мощнее и он точный, без аппроксимаций.
    -   Для больших выборок Хи-квадрарт - т.к. на больших выборках он мощнее + вычислительнее гораздо эффективнее
-   Критическое значение статистик:
    -   Хи-квадрат при степени свободы = 1: 3.841
    -   Фишер: нет критического значения (он выдаёт вероятность)
    -   
        -   в обоих случаях будем использовать двусторонние тесты, т.к. предположим, что у нас нет понимания, связь в какую стороны мы обнаружим (или не обнаружим).

Большая выборка:

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c('High', 'Low'), each=sample_size / 2)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)
cardio_high_activity <- sample(
  c("Cardio_Yes", "Cardio_No"),
  size = sample_size / 2,
  replace = TRUE,
  prob = c(0.5, 0.5)
)

cardio_low_activity <- sample(
  c("Cardio_Yes", "Cardio_No"),
  size = sample_size / 2,
  replace = TRUE,
  prob = c(0.6, 0.4)
)

data <- tibble(
  Activity = activity,
  Cardiovascular_Disease = c(cardio_high_activity, cardio_low_activity)
)

# Check the distribution
table(data)

# Use chi-square test
print(chisq.test(table(data)))
```

При Sample-size = 100 не можем отвергнуть нулевую гипотезу (при нашей рандомизации с seed=42) по хи-квадрату.
По экспериментам заметил, что при n\>=300 начинается область "стат.значимости", в которой мы начинаем отвергать нулевую гипотезу о независимости.

Маленькая выборка:

```{r}

sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c('High', 'Low'), each=sample_size / 2)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)
cardio_high_activity <- sample(
  c("Cardio_Yes", "Cardio_No"),
  size = sample_size / 2,
  replace = TRUE,
  prob = c(0.5, 0.5)
)

cardio_low_activity <- sample(
  c("Cardio_Yes", "Cardio_No"),
  size = sample_size / 2,
  replace = TRUE,
  prob = c(0.6, 0.4)
)

data <- tibble(
  Activity = activity,
  Cardiovascular_Disease = c(cardio_high_activity, cardio_low_activity)
)

# Check the distribution
table(data)

# Use chi-square test
print(fisher.test(table(data)))
```

-   Наблюдаемые значения статистик:
    -   Хи-квадрат: 0
    -   Фишер: отсутствует (p=1.0)
-   Результаты: в обоих случаях (n=100, 30) не получилось отвергнуть нулевую гипотезу. Отметим, что при выборках больше 300, хи-квадрат уже позволяет обнаружить стат. значимость.
-   Практическая значимость: я бы сказал, что 10% увеличения кардио заболеваний без активного занятие спортом (что мы закладывали в ген. совокупность) это очень важно. Такие вещи надо бы находить.

# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80

# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(sample_size, mean=130, sd=2.5)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean=135, sd=2.5)  # контрольная группа
```

NB: SD берем 2.5 и равным между группами

## Решение

```{r}
print(t.test(group1, group2))

mean_group1 <- mean(group1)
n_group1 <- length(group1)
sd_group1 <- sd(group1) 
margin_error_gr1 <- 1.960 * (sd_group1 / sqrt(n_group1))

mean_group2 <- mean(group2)
n_group2 <- length(group2)
sd_group2 <- sd(group2)
margin_error_gr2 <- 1.960 * (sd_group2 / sqrt(n_group2))


cat("CI-lower for Experimental group:", mean_group1 - margin_error_gr1, "Upper:", mean_group1 + margin_error_gr1, "\n")
cat("CI-lower for Control group:", mean_group2 - margin_error_gr2, "Upper:", mean_group2 + margin_error_gr2)
```

-   Гипотезы:
    -   Нулевая гипотеза: применение экпериментального лечения не изменяет среднее артериального давление у людей с гипертензией (среднии равны между группами с/без экс. лечения)
    -   Альтернативная гипотеза: среднии между группами лечений различаются
    -   Опять же используем двусторонний тест, т.к. лечение экспериментальное и оно может приводить к любому исходу. Но, со своей стороны, я бы согласился и с односторонним тестом здесь.
-   Уровень значимости: классический, alpha = 0.05
-   Стат.тест:
    -   Используем t-test. У нас всё подходит к нему [Welch Two Sample t-test]  считаем что дисперсии не известны и не равны.
-   Критическое значение статистик:
    -   Используем t-test (на 80 образцах, поэтому почти что нормальное распределение) - критическое значение, +-1.990 (в обе стороны, с расчётом df по методу Уелча)
-   Наблюдаемые значения статистик:
    -   t = -8.7751
-   Результаты:
    -   Получение критическое значение статистики, значит, отвергаем нулевую гипотезу.
    -   CI для средних: 
        -   группа с эксп. лечением - 129.4615 - 130.6393
        -   группа с обычным лечением - 134.2345 - 135.2416
-   Практическая значимость: разница между средними очень большая, я не врач, но понижение на 5мм. для группы пациентов, которые уже в риске (гипертензия) может быть критически важно.

# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных
У нас зависимые выборки!
```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rnorm(n=sample_size, mean=50, sd=5)

# Генерация данных после реабилитации
after <- rnorm(n=sample_size, mean=60, sd=5)  
```
NB: раньше тут была заготовка с rbinom функцией, но не совсем 

## Решение

```{r}
t.test(after, before, alternative='greater', paired=TRUE)
```

-   Гипотезы:
    -   Нулевая гипотеза: внедрение программы реабилитации для пациентов с хронической болью в спине не увеличивает их физической активности (средняя активность после реабилитации <= среднему до реабилитации).
    -   Альтернативная гипотеза: средние между до и после реабилитации различаются => среднее после реабилитации выше, чем до
    -   Здесь используем одностороннюю альтернативную гипотезу
-   Уровень значимости: классический, alpha = 0.05
-   Стат.тест:
    -   Используем t-test для зависимых выборок (парный т-тест).
-   Критическое значение статистик:
    -   Используем t-test (на 80 образцах, поэтому почти что нормальное распределение) - критическое значение, +1.697 (в одну сторону)
-   Наблюдаемые значения статистик:
    -   t = +5.5271
-   Результаты:
    -   Получение критическое значение статистики, значит, отвергаем нулевую гипотезу.
-   Практическая значимость: конечно, все зависит от шкалы. Есть ли важные различия между 50 и 60 по этой шкале. С оценки цифр, увеличение активности на 20% после реабилитации выглядит очень значимо практически.

# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(420)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
treatment <- rep(c('Exerimental', 'Conservative'), each=sample_size / 2)

# У активных людей меньше вероятность заболеть (0.5 vs 0.6)
exp_activity <- sample(
  c(1, 0),
  size = sample_size / 2,
  replace = TRUE,
  prob = c(0.7, 0.3)
)

cosv_activity <- sample(
  c(1, 0),
  size = sample_size / 2,
  replace = TRUE,
  prob = c(0.65, 0.35)
)

data <- tibble(
  Treatment = treatment,
  Activity = c(exp_activity, cosv_activity)
)

# Check the distribution
table(data)
```
NB: изменил set.seed - т.к. на 42 получались слишком странные результаты.

## Решение
Попробуем использовать асимптотический тест на доли
```{r}
z_test_proportions <- function(x1, n1, x2, n2, alternative = "two.sided") {
  # Calculate proportions
  p1 <- x1 / n1
  p2 <- x2 / n2
  
  # Pooled proportion
  p_pooled <- (x1 + x2) / (n1 + n2)
  
  # Standard error
  se <- sqrt(p_pooled * (1 - p_pooled) * (1 / n1 + 1 / n2))
  
  # Z-statistic
  z <- (p1 - p2) / se
  
  # Calculate p-value based on the alternative hypothesis
  if (alternative == "two.sided") {
    p_value <- 2 * pnorm(-abs(z))
  } else if (alternative == "greater") {
    p_value <- 1 - pnorm(z)
  } else if (alternative == "less") {
    p_value <- pnorm(z)
  } else {
    stop("Invalid alternative hypothesis. Choose 'two.sided', 'greater', or 'less'.")
  }
  
  # Return results as a list
  return(list(
    z_statistic = z,
    p_value = p_value,
    proportion_1 = p1,
    proportion_2 = p2,
    pooled_proportion = p_pooled
  ))
}

# Data
x1 <- table(data)[4] # Successes in group 1
n1 <- sample_size/2 # Sample size of group 1
x2 <- table(data)[3] # Successes in group 2
n2 <- sample_size/2 # Sample size of group 2
z_test_proportions(x1, n1, x2, n2, alternative = "greater")
```
-   Гипотезы:
    -   Нулевая гипотеза: применение нового метода лечения для пациентов с инфарктом миокарда не изменяет долю вернувшихся к нормальной физической активности (доля в группе c новым лечением меньше или равна доли в группе со старым лечением)
    -   Альтернативная ги потеза: доли между группами различаются => доля в группе с новым лечением больше
    -   Здесь используем односторонний тест Superiority >=
-   Уровень значимости: классический, alpha = 0.05
-   Стат.тест:
    -   Асимптотический тест на доли для двух групп
-   Критическое значение статистик:
    -   Односторонний с alpha=0.05 => 1.645
-   Наблюдаемые значения статистик:
    -   z_statistic = 0.8574929
-   Результаты:
    -   Получение НЕкритическое значение статистики, значит, не можем отвергнуть нулевую гипотезу.
-   Практическая значимость: здесь, конечно, нужна бОльшая выборка для док-ва разницы.


# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных

NB: выборки зависимые
```{r}

# Воспроизводимость результатов
set.seed(420)

# Общий размер выборки 
sample_size <- 50

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
meditation <- rep(c('After', 'Before'), each=sample_size)

# У активных людей меньше вероятность заболеть (0.5 vs 0.6)
stress_med <- sample(
  c("Yes", "No"),
  size = sample_size,
  replace = TRUE,
  prob = c(0.2, 0.8)
)

stress_no_med <- sample(
  c("Yes", "No"),
  size = sample_size,
  replace = TRUE,
  prob = c(0.4, 0.6)
)

data <- tibble(
  Meditation = meditation,
  Cardiovascular_Disease = c(stress_med, stress_no_med)
)

# Check the distribution
table(data)
```
## Решение

```{r}
print(mcnemar.test(table(data)))
```

-   Гипотезы (здесь будем проверять ассоциацию):
    -   Нулевая гипотеза: применение не ассоциировано с наличием стресса
    -   Альтернативная ги потеза: ассоциация есть
    -   Гипотеза двустороняя
-   Уровень значимости: классический, alpha = 0.05
-   Стат.тест:
    -   Критерий McNemar
-   Критическое значение статистик:
    -   Хи-квадрат (n=1): +-5.0
-   Наблюдаемые значения статистик:
    -   statistic = +11.6
-   Результаты:
    -   Получение критическое значение статистики, значит, можем отвергнуть нулевую гипотезу.
-   Практическая значимость: на наших данных обнаружили, что медитация помогает в борьбе со стрессом.



# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

## Генерация данных
Датасет сделаем на нормальном распределении, это, в целом, нас ни к чему не будет обязывать.
```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20

# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rnorm(20, mean=55, sd=8)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(20, mean=68, sd=10)  # контрольная группа
```

## Решение

```{r}
print(t.test(group1, group2))

mean_group1 <- mean(group1)
n_group1 <- length(group1)
sd_group1 <- sd(group1) 
margin_error_gr1 <- 2.086 * (sd_group1 / sqrt(n_group1))

mean_group2 <- mean(group2)
n_group2 <- length(group2)
sd_group2 <- sd(group2)
margin_error_gr2 <- 2.086 * (sd_group2 / sqrt(n_group2))


cat("CI-lower for Experimental group:", mean_group1 - margin_error_gr1, "Upper:", mean_group1 + margin_error_gr1, "\n")
cat("CI-lower for Control group:", mean_group2 - margin_error_gr2, "Upper:", mean_group2 + margin_error_gr2)
```
-   Гипотезы (здесь будем проверять ассоциацию):
    -   Нулевая гипотеза: применение альтернативного метода не приведет к значимому изменению уровня симптомов депрессии (среднии между группами будут равны)
    -   Альтернативная ги потеза: (среднии) уровни симптомов депрессии не одинаковые между группами
    -   Гипотеза двустороняя
-   Уровень значимости: классический, alpha = 0.05
-   Стат.тест:
    -   T-test Welch's method. Важно, что здесь мы не делаем предположений о том, как распределены оригинальные скоры в группах, спокойно пользуемся т-тестом. 
-   Критическое значение статистик:
    -   t-dist (n=38): +-2.021
-   Наблюдаемые значения статистик:
    -   statistic = 2.5627
-   Результаты:
    -   Получение критическое значение статистики, значит, можем отвергнуть нулевую гипотезу.
    -   Что интересно, видим, что CI между группами пересекаются (см. выше). То, что CI перескаются, а в тесте мы получили стат.значимость связано с тем, что в тесте Уелча статистика по-другому считается и дисперсия высчитывается спец. образом, т.о. отсюда и различия. Однако, с моей точки зрения, разница между группами достаточно сильная, что конечно не должно нас останавливать на этой небольшой выборке. 
-   Практическая значимость: Доп. исследования нужны для валидации находки. 

# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7., 5.)

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1.5, -0.5*1.5*1.0, -0.5*1.5*1.0, 1.0), nrow = 2)

df <- rmvnorm(n = 100, 
              mean = means, 
              sigma = cov_matrix, ) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))
df
```

## Решение (дополните решение визуализацией)
Чтобы использовать те тесты, которые мы прошли, здесь можно бы сделать по колонкам HoursOfSleep и StressLevel категоризацию на High/Low по медиане (используя информацию о всей колонке) и использовать методы анализа ассоциаций между категориями. [Конечно, проще было бы здесь использовать корреляцию спирмена и посмотреть на неё].

```{r}
our_table = df %>% mutate(Sleep_High_Low = HoursOfSleep > median(HoursOfSleep), 
              Stress_High_Low = StressLevel > median(StressLevel)) %>% 
  with(table(Sleep_High_Low, Stress_High_Low))

our_table
```
```{r}
chisq.test(our_table)
```
-   Гипотезы (здесь будем проверять ассоциацию):
    -   Нулевая гипотеза: длительность сна не ассоциирована со стрессом
    -   Альтернативная гипотеза: существует ассоциация между двумя этими категориями
    -   Гипотеза двустороняя
-   Уровень значимости: классический, alpha = 0.05
-   Стат.тест:
    -   Хи-квадрат - т.к. у нас достаточная выборка
-   Критическое значение статистик:
    -   Хи-квадрат при степени свободы = 1: 3.841 (двусторонний)
-   Наблюдаемые значения статистик:
    -   statistic = 17.64
-   Результаты:
    -   Получение критическое значение статистики, значит, можем отвергнуть нулевую гипотезу.
-   Практическая значимость: Есть ассоциация между сном и уровнем стресса - нужны более точные исследования для того, чтобы изучить эту связь

```{r}
# Mutate and plot
df %>%
  mutate(
    Sleep_High_Low = HoursOfSleep > median(HoursOfSleep),
    Stress_High_Low = StressLevel > median(StressLevel)
  ) %>%
  ggplot(aes(x = HoursOfSleep, y = StressLevel)) +
  geom_point(aes(color = Stress_High_Low, shape = Sleep_High_Low), size = 3) +  # Enhanced point aesthetics
  geom_hline(yintercept = median(df$StressLevel), linetype = "dashed", color = "red", size = 0.8) +
  geom_vline(xintercept = median(df$HoursOfSleep), linetype = "dashed", color = "blue", size = 0.8) +
  labs(
    title = "Relationship Between Sleep and Stress Levels",
    x = "Hours of Sleep",
    y = "Stress Level",
    color = "High Stress Level",
    shape = "High Sleep Level"
  ) +
  scale_color_manual(values = c("blue", "orange")) +  # Custom colors for better contrast
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Centered and bold title
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )

```


